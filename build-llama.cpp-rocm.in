#!/usr/bin/env bash
#
# Copyright Â© 2025 Revolution Robotics, Inc.
#
# SPDX-License-Identifier: MIT
#
# @(#) build-llama.cpp-cuda
#
# This script builds llama.cpp with CUDA and Intel cuBLAS support.
# Both the latest CUDA and Intel OneAPI hpc toolkit are installed as
# needed. In addition, the asdf version manager is installed as needed
# and used to install the latest Python 3.11.x.
#
: ${ASDF_CMD="${HOME}/bin/asdf"}
: ${CAT_CMD:='@CAT_CMD@'}
: ${CMAKE_CMD:='@CMAKE_CMD@'}
: ${ED_CMD:='@ED_CMD@'}
: ${GIT_CMD:='@GIT_CMD@'}
: ${GREP_CMD:='@GREP_CMD@'}
: ${MAKE_CMD:='@MAKE_CMD@'}
: ${NPROC_CMD:='@NPROC_CMD@'}
: ${PATCH_CMD:='@PATCH_CMD@'}
: ${PIP_CMD:="${HOME}/.asdf/shims/pip"}
: ${READLINK_CMD:='@READLINK_CMD@'}
: ${RM_CMD:='@RM_CMD@'}
: ${SORT_CMD:='@SORT_CMD@'}
: ${SUDO_CMD:='@SUDO_CMD@'}
: ${TEE_CMD:='@TEE_CMD@'}

: ${INSTALL_PREFIX:='/usr/local'}
: ${AMDGPU_TARGET:='gfx1151'}
: ${ONEAPI_ROOT:='/opt/intel/oneapi'}
: ${ROCM_ROOT:='/opt/rocm'}
: ${OMPI_ROOT:='/usr/local'}
: ${UCX_ROOT:='/usr/local'}

# OS-agnstoic readlink for existent files/directories.
resolve-existing ()
{
    if $READLINK_CMD --version 2>&1 | $GREP_CMD -q 'coreutils'; then
        $READLINK_CMD -e "$@"
    else
        $READLINK_CMD -f N "$@"
    fi
}

set-alternatives ()
{
    local name=$1
    local path=$2

    if command -v "$UPDATE_ALTERNATIVES_CMD" >/dev/null; then
        if $UPDATE_ALTERNATIVES_CMD --list |
                $AWK_CMD '{ print $1 }' |
                $GREP_CMD -q "^${name}\>" &&
                test -f "$path"; then
            $SUDO_CMD $UPDATE_ALTERNATIVES_CMD --set "$name" "$path"
        fi
    fi
}

check-oneapi-env ()
{
    local oneapi_root=$1

    if test ! -d "$oneapi_root"; then
        $SUDO_CMD -i ${script_dir}/install-intel-oneapi-hpc || return $?
    fi

    if ! command -v icx >/dev/null; then
        source /opt/intel/oneapi/setvars.sh
    fi
}

check-rocm-env ()
{
    local amdgpu_target=$1
    local ucx_root=$2
    local ompi_root=$3
    local rocm_root=$4

    if test ! -d "${rocm_root}/bin"; then
        $SUDO_CMD -i ${script_dir}/install-rocm-binaries \
                  "$amdgpu_target" \
                  "$ucx_root" \
                  "$ompi_root" \
                  "$rocm_root" \
            || return $?
    fi

    if ! $GREP_CMD -q rocm <<<$PATH; then
        export PATH=${rocm_root}/bin:${PATH}
    fi

    if ! command -v rocminfo >/dev/null; then
        echo "Error: ROCm installation not found in ${ROCM_ROOT}" >&2
        return 1
    fi
}

verify-python ()
{
    local version=$1

    if ! command -v "$ASDF_CMD" >/dev/null && test -x "${HOME}/bin/asdf"; then
        export PATH=${PATH}:${HOME}/bin
    fi

    if command -v "$ASDF_CMD" >/dev/null; then
        if [[ ! ."$PATH" =~ ^\..*\.asdf/shims ]]; then
            export PATH=${HOME}/.asdf/shims:${PATH}
        fi

        python_available=$(
            $ED_CMD -s <(cd "$script_dir" && $ASDF_CMD list) <<EOF
g/^python/1,.d
g/^[a-z]/.,\$d
,! $GREP_CMD "$version" | $SORT_CMD -V
p
Q
EOF
                        ) || return $?

        case "$python_available" in
            *'*'${version}*)
                : Nothing to do
                ;;
            *${version}*)
                echo "python${python_available}" >>${script_dir}/.tool-versions
                ;;
            *)
                $ASDF_CMD plugin add python || return $?
                latest=$($ASDF_CMD latest python 3.11)
                $ASDF_CMD install python "$latest" || return $?
                (cd "$script_dir" && $ASDF_CMD set python "$latest") || return $?
                $ASDF_CMD reshim python || return $?

                export PATH=${HOME}/.asdf/shims:${PATH}:${HOME}/bin
                ;;
        esac
    else
        ${script_dir}/install-asdf || return $?
        $ASDF_CMD plugin add python || return $?
        latest=$($ASDF_CMD latest python 3.11)
        $ASDF_CMD install python "$latest" || return $?
        (cd "$script_dir" && $ASDF_CMD set python "$latest") || return $?
        $ASDF_CMD reshim python || return $?

        export PATH=${HOME}/.asdf/shims:${PATH}:${HOME}/bin
    fi
}

clone-repo ()
{
    local repo_url=$1
    local srcdir=$2

    if test -d "${srcdir}/.git"; then
        $GIT_CMD -C "$srcdir" pull --rebase || return $?
    else
        $INSTALL_CMD -d -m 0755 "${srcdir%/*}" || return $?
        $GIT_CMD -C "${srcdir%/*}" clone "$repo_url" "${srcdir##*/}" || return $?
    fi
}

patch-repo ()
{
    local srcdir=$1
    local patchdir=$2

    local up_to_date=''

    up_to_date=$(
        $GIT_CMD -C "$srcdir" log \
                 --pretty=reference --grep 'Update Python scripts.'
           ) || return $?

    if test ."$up_to_date" != .''; then
        return 0
    fi

    local patchfile=''

    for patchfile in "${patchdir}/"*.diff; do
        $PATCH_CMD -d "$srcdir" <"$patchfile" || return $?
    done

    $CAT_CMD >&2 <<'EOF'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!! Enter git credentials for commit: 'Assign golang path.': !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
EOF
    $GIT_CMD -C "$srcdir" commit -a -m 'Update Python scripts.'
}

build-llama.cpp ()
{
    local srcdir=$1
    local install_prefix=$2

    local builddir=${srcdir}/build

    $RM_CMD -rf "$builddir" || return $?
    HIPCXX="$(hipconfig -l)/clang" \
          HIP_PATH="$(hipconfig -R)" \
          HIP_PLATFORM=amd \
          $CMAKE_CMD \
              -S "$srcdir" \
              -B "$builddir" \
              -DCMAKE_INSTALL_PREFIX="${install_prefix}" \
              -DCMAKE_INSTALL_RPATH="${install_prefix}/lib64" \
              -DGGML_HIP=ON \
              -DGGML_HIP_ROCWMMA_FATTN=ON \
              -DAMDGPU_TARGETS=gfx1151 \
              -DCMAKE_BUILD_TYPE=Release \
              -DLLAMA_CURL=ON \
        || return $?

# OneAPI CMake options
#               -DCMAKE_INSTALL_RPATH="${install_prefix}/lib64;${ONEAPI_ROOT}/compiler/latest/lib;${ONEAPI_ROOT}/mkl/latest/lib" \
#               -DGGML_BLAS=ON \
#               -DGGML_BLAS_VENDOR=Intel10_64lp \
#               -DCMAKE_C_COMPILER=icx \
#               -DCMAKE_CXX_COMPILER=icpx \
#               -DGGML_NATIVE=ON \

    $MAKE_CMD -C "$builddir" -j$($NPROC_CMD) |&
        $TEE_CMD "${builddir}/build.OUT"
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    declare script=''
    declare script_dir=''
    declare script_name=''

    script=$(resolve-existing "$0") || exit $?
    script_name=${script##*/}
    script_dir=${script%/*}

    if (( EUID == 0 )); then
        echo "${script_name}: This script must not be run by user root." >&2
        exit 1
    fi

    declare top_srcdir=''

    top_srcdir=$(
        cd "$script_dir" && $GIT_CMD rev-parse --show-toplevel
              ) || true

    declare abs_srcdir=${1:-"$top_srcdir"}
    declare install_prefix=${2:-"$INSTALL_PREFIX"}
    declare amdgpu_target=${3:-"$AMDGPU_TARGET"}
    declare rocm_root=${4:-"$ROCM_ROOT"}
    declare ompi_root=${5:-"$OMPI_ROOT"}
    declare ucx_root=${6:-"$UCX_ROOT"}
    declare oneapi_root=${7:-"$ONEAPI_ROOT"}

    declare llama_repo_url='https://github.com/ggml-org/llama.cpp.git'
    declare llama_srcdir=${script_dir}/src/llama.cpp
    declare llama_patchdir=${abs_srcdir}/patches/llama.cpp
    declare py_version='3\.11'

    echo "Building llama.cpp with ROCm and Intel cuBLAS support" >&2

    # check-oneapi-env "$oneapi_root" || exit $?
    check-rocm-env "$amdgpu_target" "$ucx_root" "$ompi_root" "$rocm_root" || exit $?
    verify-python "$py_version" || exit $?
    clone-repo "$llama_repo_url" "$llama_srcdir" || exit $?
    # patch-repo "$llama_srcdir" "$llama_patchdir" || exit $?
    # set-alternatives gcc /usr/bin/x86_64-linux-gnu-gcc-15 || exit $?
    # set-alternatives g++ /usr/bin/x86_64-linux-gnu-g++-15 || exit $?
    # set-alternatives gfortran /usr/bin/x86_64-linux-gnu-gfortran-15 || exit $?
    build-llama.cpp "$llama_srcdir" "$install_prefix" || exit $?
fi
