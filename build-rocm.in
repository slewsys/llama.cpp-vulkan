#!/usr/bin/env bash
#
# @(#) build-rocm.sh
#
: ${APT_CMD:='@APT_CMD@'}
: ${ASDF_CMD="${HOME}/bin/asdf"}
: ${AWK_CMD:='@AWK_CMD@'}
: ${CAT_CMD:='@CAT_CMD@'}
: ${CMAKE_CMD:='@CMAKE_CMD@'}
: ${DNF_CMD:='@DNF_CMD@'}
: ${ED_CMD:='@ED_CMD@'}
: ${GIT_CMD:='@GIT_CMD@'}
: ${GREP_CMD:='@GREP_CMD@'}
: ${INSTALL_CMD:='@INSTALL_CMD@'}
: ${MAKE_CMD:='@MAKE_CMD@'}
: ${PATCH_CMD:='@PATCH_CMD@'}
: ${PIP_CMD:="${HOME}/.asdf/shims/pip"}
: ${READLINK_CMD:='@READLINK_CMD@'}
: ${RM_CMD:='@RM_CMD@'}
: ${SORT_CMD:='@SORT_CMD@'}
: ${SUDO_CMD:='@SUDO_CMD@'}
: ${TEE_CMD:='@TEE_CMD@'}
: ${UPDATE_ALTERNATIVES_CMD:='@UPDATE_ALTERNATIVES_CMD@'}

: ${INSTALL_PREFIX:='/usr/local'}

# OS-agnstoic readlink for existent files/directories.
resolve-existing ()
{
    if $READLINK_CMD --version 2>&1 | $GREP_CMD -q 'coreutils'; then
        $READLINK_CMD -e "$@"
    else
        $READLINK_CMD -f N "$@"
    fi
}

set-alternatives ()
{
    local name=$1
    local path=$2

    if command -v "$UPDATE_ALTERNATIVES_CMD" >/dev/null; then
        source /etc/os-release

        case $ID in
            fedora)
                if $UPDATE_ALTERNATIVES_CMD --list |
                        $AWK_CMD '{ print $1 }' |
                        $GREP_CMD -q "^${name}\>" &&
                        test -f "$path"; then
                    $SUDO_CMD $UPDATE_ALTERNATIVES_CMD --set "$name" "$path"
                fi
                ;;
            debian)
                if $UPDATE_ALTERNATIVES_CMD --get-selections |
                        $AWK_CMD '{ print $1 }' |
                        $GREP_CMD -q "^${name}\>" &&
                        test -f "$path"; then
                    $SUDO_CMD $UPDATE_ALTERNATIVES_CMD --set "$name" "$path"
                fi
                ;;
        esac
    fi
}

verify-python ()
{
    local version=$1

    pushd "$script_dir" >/dev/null || return $?

    if ! command -v "$ASDF_CMD" >/dev/null && test -x "${HOME}/bin/asdf"; then
        export PATH=${PATH}:${HOME}/bin
    fi

    if command -v "$ASDF_CMD" >/dev/null; then
        if [[ ! ."$PATH" =~ ^\..*\.asdf/shims ]]; then
            export PATH=${HOME}/.asdf/shims:${PATH}
        fi

        python_available=$(
            $ED_CMD -s <($ASDF_CMD list) <<EOF
g/^python/1,.d
g/^[a-z]/.,\$d
,! $GREP_CMD "$version" | $SORT_CMD -V
p
Q
EOF
                        ) || return $?

        case "$python_available" in
            *'*'${version}*)
                : Nothing to do
                ;;
            *${version}*)
                echo "python${python_available}" >>${script_dir}/.tool-versions
                ;;
            *)
                $ASDF_CMD plugin add python || return $?
                latest=$(eval $ASDF_CMD latest python "$version")
                $ASDF_CMD install python "$latest" || return $?
                $ASDF_CMD set python "$latest" || return $?
                ;;
        esac
    else
        ${script_dir}/scripts/install-asdf || return $?
        $ASDF_CMD plugin add python || return $?
        latest=$(eval $ASDF_CMD latest python "$version")
        $ASDF_CMD install python "$latest" || return $?
        $ASDF_CMD set python "$latest" || return $?
        $ASDF_CMD reshim python || return $?

        export PATH=${HOME}/.asdf/shims:${PATH}:${HOME}/bin
    fi

    popd >/dev/null || return $?
}

install-prerequisites ()
{
    source /etc/os-release

    case "$ID" in
        fedora)
            if command -v gcc >/dev/null                                \
                    && command -v g++ >/dev/null                        \
                    && command -v gfortran >/dev/null; then
                $SUDO_CMD $DNF_CMD install -y automake ccache cmake     \
                          doxygen git git-lfs libquadmath-devel libtool \
                          mesa-libEGL-devel ninja-build patchelf        \
                          pkgconf-pkg-config python3-devel xxd          \
                    || return $?
            else
                $SUDO_CMD $DNF_CMD install -y automake cmake ccache     \
                          doxygen gcc gfortran g++ git git-lfs libtool  \
                          libquadmath-devel mesa-libEGL-devel patchelf  \
                          ninja-build pkgconf-pkg-config python3-devel  \
                          xxd                                           \
                    || return $?
            fi
            ;;
        debian|ubuntu)
            if command -v gcc >/dev/null                                \
                    && command -v g++ >/dev/null                        \
                    && command -v gfortran >/dev/null; then
                $SUDO_CMD $APT_CMD install -y automake cmake ccache     \
                          doxygen git git-lfs libegl1-mesa-dev libtool  \
                          libquadmath0 libtool-bin ninja-build patchelf \
                          pkgconf python3-dev xxd                       \
                    || return $?
            else
                $SUDO_CMD $APT_CMD install -y automake cmake ccache     \
                          doxygen gcc gfortran g++ git git-lfs libtool  \
                          libquadmath0 libegl1-mesa-dev libtool-bin     \
                          ninja-build patchelf pkgconf python3-dev xxd  \
                    || return $?

            fi
            ;;
    esac
}

clone-repo ()
{
    local repo_url=$1
    local srcdir=$2

    if test -d "${srcdir}/.git"; then
        $GIT_CMD -C "$srcdir" pull --rebase || return $?
    else
        # $GIT_CMD clone --single-branch --filter=tree:0 https://github.com/ROCm/TheRock.git
        $INSTALL_CMD -d -m 0755 "${srcdir%/*}" || return $?
        $GIT_CMD -C "${srcdir%/*}" clone "$repo_url" "${srcdir##*/}"|| return $?
    fi
}

configure-env ()
{
    local srcdir=$1

    pushd "$srcdir" >/dev/null
    # set-alternatives gcc /usr/bin/x86_64-linux-gnu-gcc-14 || return $?
    # set-alternatives g++ /usr/bin/x86_64-linux-gnu-g++-14 || return $?
    # set-alternatives gfortran /usr/bin/x86_64-linux-gnu-gfortran-14 || return $?
    $PIP_CMD install -r requirements.txt || return $?
    build_tools/fetch_sources.py || return $?
    eval $(build_tools/setup_ccache.py) || return $?
    export CCACHE_SLOPPINESS=include_file_ctime
    popd >/dev/null
}

build-rocm ()
{
    local srcdir=$1

    echo "*** TheRock CMake configuration ***" >&2

    pushd "$srcdir" >/dev/null
    CFLAGS=-I/usr/lib/gcc/x86_64-redhat-linux/15/include/               \
    CXXFLAGS=-I/usr/lib/gcc/x86_64-redhat-linux/15/include/             \
    $CMAKE_CMD -B build                                                 \
               -GNinja                                                  \
               -DCMAKE_INSTALL_PREFIX=/usr/local                        \
               -DTHEROCK_AMDGPU_TARGETS=gfx1151                         \
               -DTHEROCK_ENABLE_MPI=ON                                  \
               -DCMAKE_C_COMPILER_LAUNCHER=ccache                       \
               -DCMAKE_CXX_COMPILER_LAUNCHER=ccache                     \
               . |& $TEE_CMD "${srcdir}/build/conf.OUT"

    echo "*** TheRock CMake build ***" >&2

    $CMAKE_CMD --build build |& $TEE_CMD "${srcdir}/build/build.OUT"
    popd >/dev/null

    # set-alternatives gcc /usr/bin/x86_64-linux-gnu-gcc-14 || return $?
    # set-alternatives g++ /usr/bin/x86_64-linux-gnu-g++-14 || return $?
    # set-alternatives gfortran /usr/bin/x86_64-linux-gnu-gfortran-14 || return $?
}

rebuild-rocm ()
{
    local srcdir=$1

    echo "*** TheRock CMake resume build ***" >&2

    pushd "$srcdir" >/dev/null
    $CMAKE_CMD --build build |& $TEE_CMD -a "${srcdir}/build/build.OUT"
    popd >/dev/null
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    declare script=''
    declare script_dir=''
    declare script_name=''

    script=$(resolve-existing "$0") || exit $?
    script_name=${script##*/}
    script_dir=${script%/*}

    declare py_version='3\.12'
    declare rocm_repo_url='https://github.com/ROCm/TheRock.git'
    declare rocm_srcdir=${script_dir}/src/TheRock
    declare top_srcdir=$(git rev-parse --show-toplevel)

    verify-python "$py_version" || exit $?
    install-prerequisites || exit $?
    clone-repo "$rocm_repo_url" "$rocm_srcdir" || exit $?
    configure-env "$rocm_srcdir"
    if (( $# == 0 )); then
        build-rocm "$rocm_srcdir" || exit $?
    else
        rebuild-rocm "$rocm_srcdir" || exit $?
    fi
fi
