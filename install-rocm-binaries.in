#!/usr/bin/env bash
#
# @(#) install-rocm-binaries
#
# This script fetches and installs the latest version ROCm nightly
# builds.
#
: ${CURL_CMD:='@CURL_CMD@'}
: ${GZIP_CMD:='@GZIP_CMD@'}
: ${INSTALL_CMD:='@INSTALL_CMD@'}
: ${JQ_CMD:='@JQ_CMD@'}
: ${RM_CMD:='@RM_CMD@'}
: ${SED_CMD:='@SED_CMD@'}
: ${SUDO_CMD:='@SUDO_CMD@'}
: ${TAR_CMD:='@TAR_CMD@'}
: ${TOUCH_CMD:='@TOUCH_CMD@'}

: ${AMDGPU_TARGET:='gfx1151'}
: ${ROCM_ROOT:='/opt/rocm'}
: ${OMPI_ROOT:='/usr/local'}
: ${UCX_ROOT:='/usr/local'}

get-latest-build ()
{
    local target=linux-${1}
    local index_url=${2}/index.html

    $CURL_CMD -sSL --no-buffer "$index_url" |
        $SED_CMD -e '/const files = /!d' \
                 -e 's^^{ "files": ^' \
                 -e 's^];^] }^' |
        $JQ_CMD -r '[.files[] | select(.name | contains("'$target'"))] | . | max_by(.mtime) | .name'
}

is-installed ()
{
    local rocm_root=$1
    local name=$2

    test -f "${rocm_root}/${name%.tar.gz}"
}

initialize-installdir ()
{
    local rocm_root=$1

    $SUDO_CMD $RM_CMD -rf "$rocm_root"
    $SUDO_CMD $INSTALL_CMD -d -m 0755 "$rocm_root"
}

fetch-compressed-archive ()
{
    local url=$1
    local name=$2

    echo "Fetching: ${url}/${name}" >&2

    $CURL_CMD -sSL "${url}/${name}"
}

extract-archive-stream ()
{
    local rocm_root=$1

    $GZIP_CMD -cd - |
        $SUDO_CMD $TAR_CMD -C "$rocm_root" -xf -
}

record-archive-name ()
{
    local rocm_root=$1
    local name=$2

    $SUDO_CMD $TOUCH_CMD "${rocm_root}/${name%.tar.gz}"
}

set-ldconfig ()
{
    local rocm_root=$1

    if test ! -f /etc/ld.so.conf.d/rocm.conf; then
        $SUDO_CMD $TEE_CMD >/dev/null /etc/ld.so.conf.d/rocm.conf <<<"${rocm_root}/lib" || return $?
        $SUDO_CMD $LDCONFIG_CMD || return $?
    fi
}

check-ompi-env ()
{
    local ucx_root=$1
    local ompi_root=$1
    local rocm_root=$1

    if ! command -v "${ompi_root}/bin/ompi_info" >/dev/null; then
        $SUDO_CMD -i ${script_dir}/install-opmi \
                  "$ucx_root" \
                  "$ompi_root" \
                  "$rocm_root" \
            || return $?
    fi

    if ! $GREP_CMD -q "${ompi_root}/bin" <<<$PATH; then
        export PATH=${ompi_root}/bin:${PATH}
    fi

    if ! command -v ompi_info >/dev/null; then
        echo "${script_name}: OMPI installation not found in ${ompi_root}" >&2
        return 1
    fi
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    set -o pipefail

    declare script=''
    declare script_name=''
    declare script_dir=''

    script=$(readlink -e "$0")
    script_name=${script##*/}
    script_dir=${script%/*}

    declare amdgpu_target=${1:-"$AMDGPU_TARGET"}
    declare ucx_root=${2:-"$UCX_ROOT"}
    declare ompi_root=${3:-"$OMPI_ROOT"}
    declare rocm_root=${4:-"$ROCM_ROOT"}

    declare rocm_nightly_url='https://therock-nightly-tarball.s3.amazonaws.com'
    declare latest_build=''

    if ! latest_build=$(get-latest-build "$amdgpu_target" "$rocm_nightly_url"); then
        echo "${script_name}: ${amdgpu_target}: Not found" >&2
        exit 1
    elif is-installed "$rocm_root" "$latest_build"; then
        echo "${script_name}: ${latest_build}: Already installed" >&2
        exit 0
    fi

    initialize-installdir "$rocm_root" || exit $?
    fetch-compressed-archive "$rocm_nightly_url" "$latest_build" |
        extract-archive-stream "$rocm_root" || exit $?
    record-archive-name "$rocm_root" "$latest_build"
    set-ldconfig "$rocm_root" || exit $?
    check-ompi-env "$ucx_root" "$ompi_root" "$rocm_root" || exit $?
fi
