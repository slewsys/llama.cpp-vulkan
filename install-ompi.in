#!/usr/bin/env bash
#
# @(#) install-ompi
#
# This script builds OpenMPI with ROCm support.
#
: ${APT_CMD:='@APT_CMD@'}
: ${DNF_CMD:='@DNF_CMD@'}
: ${GIT_CMD:='@GIT_CMD@'}
: ${GREP_CMD:='@GREP_CMD@'}
: ${INSTALL_CMD:='@INSTALL_CMD@'}
: ${LDCONFIG_CMD:='@LDCONFIG_CMD@'}
: ${LN_CMD:='@LN_CMD@'}
: ${MAKE_CMD:='@MAKE_CMD@'}
: ${READLINK_CMD:='@READLINK_CMD@'}
: ${SUDO_CMD:='@SUDO_CMD@'}
: ${TEE_CMD:='@TEE_CMD@'}

: ${UCX_ROOT:='/usr/local'}
: ${OMPI_ROOT:='/usr/local'}
: ${ROCM_ROOT:='/opt/rocm'}

check-ucx-env ()
{
    local ucx_root=$1
    local rocm_root=$2

    if ! command -v "${ucx_root}/bin/ucx_info" >/dev/null; then
        $SUDO_CMD -i ${script_dir}/install-ucx \
                  "$rocm_root" "$ucx_root" || return $?
    fi

    if ! $GREP_CMD -q "${ucx_root}/bin" <<<$PATH; then
        export PATH=${ucx_root}/bin:${PATH}
    fi

    if ! command -v ucx_info >/dev/null >/dev/null; then
        echo "${script_name}: UCX installation not found in ${ucx_root}" >&2
        return 1
    fi
}

install-ompi-build-prerequisites ()
{
    source /etc/os-release

    case "$ID" in
        fedora|rhel|centos|rocky)
            $SUDO_CMD $DNF_CMD install -y autoconf automake dkms gcc          \
                     git hwloc hwloc-devel jansson-devel                      \
                     java-latest-openjdk-devel kernel-devel libcurl-devel     \
                     libesmtp-devel libev-devel libevent-devel libtool        \
                     libtool-ltdl-devel make mokutil munge munge-devel        \
                     pmix-devel prrte prrte-devel python3-devel zlib-ng-devel \
                || return $?

            pushd /usr/bin >/dev/null || return $?
            $SUDO_CMD $LN_CMD -s ../lib64/openmpi/bin/* . || return $?
            popd >/dev/null || return $?
            ;;
        ubuntu|debian)
            $SUDO_CMD $APT_CMD install -y autoconf automake dkms gcc git      \
                     libhwloc-dev libjansson-dev default-jdk                  \
                     libcurl4-openssl-dev libesmtp-dev                        \
                     libev-dev libevent-dev libtool libltdl-dev               \
                     linux-headers-$(uname -r) make mokutil libpython3-dev    \
                     zlib1g-dev                                               \
                || return $?
            ;;
        *)
            echo "${script_name}: ${ID}: Unsupported OS" >&2
            return 1
            ;;
    esac
}

recursively-clone-repo ()
{
    local repo_url=$1
    local srcdir=$2

    if test -d "${srcdir}/.git"; then
        $GIT_CMD -C "$srcdir" pull --rebase || return $?
        $GIT_CMD -C "$srcdir" submodule update --recursive --remote || return $?
    else
        $INSTALL_CMD -d -m 0755 "${srcdir%/*}" || return $?
        $GIT_CMD -C "${srcdir%/*}" clone \
            --recurse-submodules "$repo_url" "${srcdir##*/}" || return $?
    fi
}

build-ompi ()
{
    local srcdir=$1
    local rocm_root=$2
    local ucx_root=$3
    local ompi_root=$4

    local builddir=${srcdir}/build

    $INSTALL_CMD -d -m 0755 "$builddir" || return $?

    pushd "$srcdir" >/dev/null
    ./autogen.pl || return $?

    pushd "$builddir" >/dev/null
    popd +1 >/dev/null

    source /etc/os-release

    case "$ID" in
        fedora|rhel|centos|rocky)
            CFLAGS='-Wl,-rpath=/usr/local/lib' ../configure \
                  --prefix="$ompi_root" \
                  --libdir="${ompi_root}/lib" \
                  --with-rocm="$rocm_root" \
                  --with-ucx="$ucx_root" \
                  --with-ucx-libdir="${ucx_root}/lib" \
                  --enable-mca-no-build=btl-uct \
                  --with-curl=/usr \
                  --with-hwloc=/usr \
                  --with-jansson=/usr \
                  --with-jdk-bindir=/lib/jvm/java-latest-openjdk/bin \
                  --with-jdk-headers=/lib/jvm/java-latest-openjdk/include \
                  --with-libltdl=/usr \
                  --with-libev=/usr \
                  --with-libevent=/usr \
                  --with-munge=/usr \
                  --with-prrte=/usr \
                  --with-pmix=/usr \
                  --with-python_prefix=/usr \
                  --with-smtp=/usr \
                  --with-zlibng=/usr \
                || return $?
            ;;
        ubuntu|debian)
            CFLAGS='-Wl,-rpath=/usr/local/lib' ../configure \
                  --prefix="$ompi_root" \
                  --libdir="${ompi_root}/lib" \
                  --with-rocm="$rocm_root" \
                  --with-ucx="$ucx_root" \
                  --with-ucx-libdir="${ucx_root}/lib" \
                  --enable-mca-no-build=btl-uct \
                  --with-curl=/usr \
                  --with-hwloc=/usr \
                  --with-jansson=/usr \
                  --with-jdk-bindir=/lib/jvm/default-java/bin \
                  --with-jdk-headers=/lib/jvm/default-java/include \
                  --with-libltdl=/usr \
                  --with-libev=/usr \
                  --with-libevent=/usr \
                  --with-prrte=internal \
                  --with-pmix=internal \
                  --with-python_prefix=/usr \
                  --with-smtp=/usr \
                  --with-zlib=/usr \
                || return $?
            ;;
        *)
            echo "${script_name}: Unsupported OS: ${ID}" >&2
            return 1
            ;;
    esac

    $MAKE_CMD |& $TEE_CMD "${builddir}/build.OUT" || return $?
    popd >/dev/null
}

install-ompi ()
{
    local srcdir=$1

    local builddir=${srcdir}/build

    $SUDO_CMD $MAKE_CMD -C "$builddir" install || return $?
}

if test ."$0" == ."${BASH_SOURCE[0]}"; then
    declare script=''
    declare script_name=''
    declare script_dir=''

    script=$($READLINK_CMD -e "$0") || exit $?
    script_name=${script##*/}
    script_dir=${script%/*}

    declare ucx_root=${1:-"$UCX_ROOT"}
    declare ompi_root=${2:-"$OMPI_ROOT"}
    declare rocm_root=${3:-"$ROCM_ROOT"}

    declare ompi_repo_url='https://github.com/open-mpi/ompi.git'
    declare ompi_srcdir=${script_dir}/src/ompi

    echo "Building and installing OpenMPI with ROCm support" >&2

    check-ucx-env "$ucx_root" "$rocm_root"
    install-ompi-build-prerequisites
    recursively-clone-repo "$ompi_repo_url" "$ompi_srcdir" || exit $?
    build-ompi "$ompi_srcdir" "$rocm_root" "$ucx_root" "$ompi_root" || exit $?
    install-ompi "$ompi_srcdir" || exit $?
fi
