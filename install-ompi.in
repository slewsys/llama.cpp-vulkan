#!/usr/bin/env bash
#
# @(#) install-ompi
#
recursively-clone-repo ()
{
    local repo_url=$1
    local srcdir=$2

    if test -d "${srcdir}/.git"; then
        git -C "$srcdir" pull --rebase || return $?
        git -C "$srcdir" submodule update --recursive --remote || return $?
    else
        install -d -m 0755 "${srcdir%/*}" || return $?
        git -C "${srcdir%/*}" clone \
            --recurse-submodules "$repo_url" "${srcdir##*/}" || return $?
    fi
}

build-ompi ()
{
    local srcdir=$1
    local rocm_root=$2
    local ucx_root=$3
    local ompi_root=$4

    local builddir=${srcdir}/build

    install -d -m 0755 "$builddir" || return $?

    pushd "$srcdir" >/dev/null
    ./autogen.pl || return $?

    pushd "$builddir" >/dev/null
    popd +1 >/dev/null
    CFLAGS='-Wl,-rpath=/usr/local/lib' ../configure \
          --prefix="$ompi_root" \
          --libdir="${ompi_root}/lib" \
          --with-rocm="$rocm_root" \
          --with-ucx="$ucx_root" \
          --with-ucx-libdir="${ucx_root}/lib" \
          --enable-mca-no-build=btl-uct \
        || return $?
    make || return $?
    popd >/dev/null
}

install-ompi ()
{
    local srcdir=$1

    local builddir=${srcdir}/build

    sudo make -C "$builddir" install || return $?
    if test ! -f /etc/ld.so.conf.d/ompi.conf; then
        sudo tee >/dev/null /etc/ld.so.conf.d/ompi.conf <<<'/opt/rocm/lib' || return $?
        sudo ldconfig || return $?
    fi
}

if test ."$0" == ."${BASH_SOURCE[0]}"; then
    declare script=''
    declare script_dir=''

    script=$(readlink -e "$0") || exit $?
    script_dir=${script%/*}

    declare ucx_root=${1:-/usr/local}
    declare ompi_root=${2:-/usr/local}
    declare rocm_root=${3:-/opt/rocm}

    declare ompi_repo_url='https://github.com/open-mpi/ompi.git'
    declare ompi_srcdir=${script_dir}/src/ompi

    if ! command -v ucx_info; then
        ${script_dir}/install-ucx "$rocm_root" "$ucx_root" || exit $?
        export PATH=${ucx_root}/bin:${PATH}
    fi

    if ! command rocm-smi; then
        export PATH=${rocm_root}/bin:${PATH}
    fi

    recursively-clone-repo "$ompi_repo_url" "$ompi_srcdir" || exit $?
    build-ompi "$ompi_srcdir" "$rocm_root" "$ucx_root" "$ompi_root" || exit $?
    install-ompi "$ompi_srcdir" || exit $?
fi
