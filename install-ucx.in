#!/usr/bin/env bash
#
# @(#) install-ucx
#
setup-rocm ()
{
    local rocm_target=$1
    local rocm_root=$2

    "${script_dir}/install-rocm-binaries" "$rocm_target" "$rocm_root"
}

clone-repo ()
{
    local repo_url=$1
    local srcdir=$2

    if test -d "${srcdir}/.git"; then
        git -C "$srcdir" pull --rebase
    else
        install -d -m 0755 "${srcdir%/*}"
        git -C "${srcdir%/*}" clone "$repo_url" "${srcdir##*/}"
    fi
}

patch-repo ()
{
    local srcdir=$1
    local patch_file=$2

    git -C "$srcdir" apply --index "$patch_file"

    echo 'Git commit: Add golang path.'
    git -C "$srcdir" commit -m 'Assign golang path.'
}

build-ucx ()
{
    local srcdir=$1
    local install_prefix=$2

    local builddir=${srcdir}/build

    mkdir "$builddir" || return $?

    pushd "$srcdir" >/dev/null
    ./autogen.sh

    pushd "$builddir" >/dev/null
    popd +1 >/dev/null
    CFLAGS='-Wl,-rpath=/usr/local/lib' ../configure  \
          --prefix="$install_prefix" \
          --libdir="${install_prefix}/lib" \
          --with-rocm=/opt/rocm \
          --with-go=$(command -v go) \
          --without-knem \
          --disable-logging \
          --disable-debug \
          --disable-assertions \
          --disable-params-check
    make clean
    make -j$(nproc)
    popd >/dev/null
}

install-ucx ()
{
    local srcdir=$1

    local builddir=${srcdir}/build

    sudo -i make -C "$builddir" install
}

if test ."$0" = ."${BASH_SOURCE[0]}"; then
    set -o pipefail

    declare script=''
    declare script_name=''
    declare script_dir=''

    script=$(readlink -e "$0")
    script_name=${script##*/}
    script_dir=${script%/*}

    declare rocm_target=${1:-'gfx1151'}
    declare rocm_root=${2:-'/opt/rocm'}
    declare ucx_root=${3:-'/usr/local'}

    declare ucx_repo_url='https://github.com/openucx/ucx.git'
    declare ucx_srcdir=${PWD}/src/ucx
    declare top_srcdir=$(git rev-parse --show-toplevel)

    setup-rocm "$rocm_target" "$rocm_root" || exit $?
    clone-repo "$ucx_repo_url" "$ucx_srcdir" || exit $?
    patch-repo "$ucx_srcdir" "${top_srcdir}/patches/patch-ucx.diff" || exit $?
    build-ucx "$ucx_srcdir" "$ucx_root" || exit $?
    install-ucx "$ucx_srcdir" || exit $?
fi
